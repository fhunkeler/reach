/*!
 * The MIT License (MIT)
 * 
 * Copyright (c) 2015 Webcom
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Reach=t():e.Reach=t()}(this,function(){return function(e){function t(o){if(n[o])return n[o].exports;var c=n[o]={exports:{},id:o,loaded:!1};return e[o].call(c.exports,c,c.exports,t),c.loaded=!0,c.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Reach=void 0;var c=n(23),a=o(c),r=n(24),i=o(r),u=n(16),d=(o(u),n(3)),s=o(d),l=n(17),f=o(l),h=n(18),m=o(h),v=n(19),p=o(v),b=n(21),S=o(b),g=t.Reach=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?"http://webcom.orange.com/base/webrtc":arguments[0];(0,a["default"])(this,e),this.datarefs=(0,f["default"])(t),this.webrtcmngr=(0,S["default"])(this.datarefs),this.webrtcmngr.setWebrtcManger(this.webrtcmngr)}return(0,i["default"])(e,[{key:"Room",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return p["default"].apply(void 0,t.concat([this.datarefs,this.webrtcmngr]))}},{key:"Reach",value:function(){for(var e=arguments.length,t=Array(e),n=0;e>n;n++)t[n]=arguments[n];return m["default"].apply(void 0,t.concat([this.datarefs]))}}],[{key:"version",get:function(){return"1.0.5"}},{key:"actions",get:function(){return s["default"]}}]),e}();e.exports=g},function(e,t){var n=e.exports={version:"2.4.0"};"number"==typeof __e&&(__e=n)},function(e,t,n){e.exports=!n(6)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t["default"]={ACTION_TYPE_AUDIO:"audio",ACTION_TYPE_VIDEO:"video",ACTION_TYPE_CHAT:"chat",ACTION_TYPE_AUDIO_VIDEO:"audio-video",ACTION_TYPE_SCREEN_SHARING:"screen-sharing",ACTION_TYPE_CALL:"call"}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function t(){return""+e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var n=t();return{appInstanceId:n}}();t["default"]=n},function(e,t,n){e.exports={"default":n(25),__esModule:!0}},function(e,t){e.exports=function(e){try{return!!e()}catch(t){return!0}}},function(e,t){var n=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){console.log("(ReachSDK::localstream::initVideo)"),p||(p=!0,navigator.getMedia=getUserMedia,h=document.createElement("VIDEO"),h.muted=!0,c.push(h),null===i?navigator.getMedia({audio:!1,video:!0},function(t){i=t,c.forEach(function(e){attachMediaStream(e,i)}),c=[],s.forEach(function(e){e(i)}),s=[],p=!1,e&&e()},function(t){console.error("Error on webrtcLocalStream - webkitGetUserMedia : error="),console.dir(t),p=!1,e&&e(t)}):(c.forEach(function(e){attachMediaStream(e,i)}),c=[],s.forEach(function(e){e(i)}),s=[],p=!1))}function t(e){console.log("(ReachSDK::localstream::initAudio)"),b||(b=!0,navigator.getMedia=getUserMedia,m=document.createElement("AUDIO"),m.muted=!0,a.push(m),null===u?navigator.getMedia({audio:!0,video:!1},function(t){u=t,a.forEach(function(e){attachMediaStream(e,u)}),a=[],l.forEach(function(e){e(u)}),l=[],b=!1,e&&e()},function(t){console.error("Error on webrtcLocalStream - webkitGetUserMedia :error="),console.dir(t),b=!1,e&&e(t)}):(a.forEach(function(e){attachMediaStream(e,u)}),a=[],l.forEach(function(e){e(u)}),l=[],b=!1))}function n(e){console.log("(ReachSDK::localstream::initAudioVideo)"),S||(S=!0,navigator.getMedia=getUserMedia,v=document.createElement("AUDIOVIDEO"),v.muted=!0,r.push(v),null===d?navigator.getMedia({audio:!0,video:!0},function(t){d=t,r.forEach(function(e){attachMediaStream(e,d)}),r=[],f.forEach(function(e){e(d)}),f=[],S=!1,e&&e()},function(t){console.error("(ReachSDK::localstream::initAudioVideo::Error on webrtcLocalStream - webkitGetUserMedia : error="),console.dir(t),S=!1,e&&e(t)}):(r.forEach(function(e){attachMediaStream(e,d)}),r=[],f.forEach(function(e){e(d)}),f=[],S=!1))}function o(){console.log("(ReachSDK::localstream::close)"),h&&(detachMediaStream(h),h=null),d&&(d.getTracks().forEach(function(e){e.stop()}),d=null),i&&(i.stop(),i=null),p=!1,m&&(detachMediaStream(m),m=null),u&&(u.stop(),u=null),b=!1,v&&(detachMediaStream(v),v=null),d&&(d.stop(),d=null),S=!1}var c=[],a=[],r=[],i=null,u=null,d=null,s=[],l=[],f=[],h=null,m=null,v=null,p=!1,b=!1,S=!1;return{getVideoStream:function(){return i},addVideoListener:function(e){s.push(e)},initVideo:function(){e()},connectLocalVideoStream:function(t,n,o){t?(t.muted=!0,i?(console.log("(ReachSDK::localstream::connectLocalVideoStream)use existing streamVideo"),attachMediaStream(t,i),o&&"function"==typeof o&&o(i)):(c.push(t),o&&"function"==typeof o&&s.push(o),e(n))):i?o&&"function"==typeof o&&o(i):(o&&"function"==typeof o&&s.push(o),e(n))},getAudioStream:function(){return u},addAudioListener:function(e){l.push(e)},initAudio:function(){t()},connectLocalAudioStream:function(e,n,o){e?(e.muted=!0,u?(console.log("(ReachSDK::localstream::connectLocalAudioStream)use existing streamAudio"),attachMediaStream(e,u),o&&"function"==typeof o&&o(u)):(a.push(e),o&&"function"==typeof o&&l.push(o),t(n))):u?o&&"function"==typeof o&&o(u):(o&&"function"==typeof o&&l.push(o),t(n))},getAudioVideoStream:function(){return d},addAudioVideoListener:function(e){f.push(e)},initAudioVideo:function(){n()},connectLocalAudioVideoStream:function(e,t,o){e?(e.muted=!0,d?(console.log("(ReachSDK::localstream::connectLocalAudioVideoStream)use existing streamAudioVideo"),attachMediaStream(e,d),o&&o(d)):(r.push(e),o&&"function"==typeof o&&f.push(o),n(t))):d?o&&o(d):(o&&"function"==typeof o&&f.push(o),n(t))},close:function(){o()}}}();t["default"]=n},function(e,t,n){e.exports={"default":n(27),__esModule:!0}},function(e,t){e.exports=function(e){if(void 0==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,n){var o=n(7),c=n(1),a=n(32),r=n(36),i="prototype",u=function(e,t,n){var d,s,l,f=e&u.F,h=e&u.G,m=e&u.S,v=e&u.P,p=e&u.B,b=e&u.W,S=h?c:c[t]||(c[t]={}),g=S[i],I=h?o:m?o[t]:(o[t]||{})[i];h&&(n=t);for(d in n)s=!f&&I&&void 0!==I[d],s&&d in S||(l=s?I[d]:n[d],S[d]=h&&"function"!=typeof I[d]?n[d]:p&&s?a(l,o):b&&I[d]==l?function(e){var t=function(t,n,o){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,n)}return new e(t,n,o)}return e.apply(this,arguments)};return t[i]=e[i],t}(l):v&&"function"==typeof l?a(Function.call,l):l,v&&((S.virtual||(S.virtual={}))[d]=l,e&u.R&&g&&!g[d]&&r(g,d,l)))};u.F=1,u.G=2,u.S=4,u.P=8,u.B=16,u.W=32,u.U=64,u.R=128,e.exports=u},function(e,t,n){var o=n(29),c=n(37),a=n(48),r=Object.defineProperty;t.f=n(2)?Object.defineProperty:function(e,t,n){if(o(e),t=a(t,!0),o(n),c)try{return r(e,t,n)}catch(i){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},function(e,t){var n=Math.ceil,o=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?o:n)(e)}},function(e,t,n){var o=n(38),c=n(11);e.exports=function(e){return o(c(e))}},function(e,t){"use strict";function n(e){e.hasOwnProperty("urls")&&(e.url=e.urls,delete e.urls),e.hasOwnProperty("url")&&e.url.toLowerCase().startsWith("turns")&&navigator.mozGetUserMedia&&console.warn("(ReachSDK::maybeFixConfiguration) turns detected on firefox -> ignore this entry")}function o(e){if(null!==e&&e.iceServers&&e.iceServers.length>0){for(var t=[],o=e.iceServers.length-1;o>=0;o--){var c=e.iceServers[o];n(c),t.push(c)}e.iceServers=t}}function c(e,t,n){var o=arguments.length<=3||void 0===arguments[3]?!1:arguments[3],c=void 0;if(o){var a=e.split("?");1!==a.length&&0!==a[1].indexOf("transport=udp")||(c={url:a[0],credential:n,username:t})}else c={url:e,credential:n,username:t};return c}if(window.RTCPeerConnection=null,window.getUserMedia=null,window.attachMediaStream=null,window.reattachMediaStream=null,window.webrtcDetectedBrowser=null,window.webrtcDetectedVersion=null,navigator.mozGetUserMedia)window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),window.RTCPeerConnection=function(e,t){return o(e),new mozRTCPeerConnection(e,t)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate,window.getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,window.createIceServer=function(e,t,n){var o=null,a=e.split(":");return 0===a[0].indexOf("stun")?o={url:e}:0===a[0].indexOf("turn")&&(o=c(e,t,n,window.webrtcDetectedVersion<27)),o},window.createIceServers=function(e,t,n){for(var o=[],c=0;c<e.length;c++){var a=window.createIceServer(e[c],t,n);null!==a&&o.push(a)}return o},window.detachMediaStream=function(e){e&&(e.mozSrcObject=null,e.pause())},window.attachMediaStream=function(e,t){try{e&&t?(e.mozSrcObject=t,e.play&&"function"==typeof e.play?e.play():console.warn("(ReachSDK::attachMediaStream)element.play not available")):console.error("ReachSDK::attachMediaStream->parameters not valid")}catch(n){console.error("(ReachSDK::attachMediaStream)Exception="+n)}},window.reattachMediaStream=function(e,t){e&&t?(e.mozSrcObject=t.mozSrcObject,e.play()):console.error("ReachSDK::reattachMediaStream->parameters not valid")},MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]});else{if(!navigator.webkitGetUserMedia)throw new Error("Browser does not appear to be WebRTC-capable");window.webrtcDetectedBrowser="chrome",window.webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),window.createIceServer=function(e,t,n){var o=null,a=e.split(":");return 0===a[0].indexOf("stun")?o={url:e}:0===a[0].indexOf("turn")&&(o=c(e,n,t)),o},window.createIceServers=function(e,t,n){var o=[];if(window.webrtcDetectedVersion>=34)o={urls:e,credential:n,username:t};else for(var c=0;c<e.length;c++){var a=window.createIceServer(e[c],t,n);null!==a&&o.push(a)}return o},window.RTCPeerConnection=function(e,t){return window.webrtcDetectedVersion<34&&o(e),new webkitRTCPeerConnection(e,t)},window.getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,window.attachMediaStream=function(e,t){try{e&&t?(e.src=URL.createObjectURL(t),e.autoplay=!0):console.error("ReachSDK::attachMediaStream ->parameters not valid")}catch(n){console.error("(ReachSDK::attachMediaStream)Exception="+n)}},window.detachMediaStream=function(e){e&&("undefined"!=typeof e.srcObject?e.srcObject="":"undefined"!=typeof e.mozSrcObject?e.mozSrcObject="":"undefined"!=typeof e.src?e.src="":console.log("Error attaching stream to element."))},window.reattachMediaStream=function(e,t){e&&t?e.src=t.src:console.error("ReachSDK::reattachMediaStream media stream->parameters not valid")}}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t["default"]=function(e){function t(){p=v.child("roomsList"),b=v.child("reach"),S=v.child("webrtc"),g=v.child("sipPhoneNumbers")}function n(){v=new Webcom(e),t()}function o(e){v=new Webcom(e),t()}function c(){return v?v.toString():void 0}function a(e){v=e,t()}function r(){return v}function i(e){p=e}function u(){return p}function d(e){b=e}function s(){return b}function l(e){S=e}function f(){return S}function h(e){g=e}function m(){return g}var v=null,p=null,b=null,S=null,g=null;return n(),{setWebcomBaseUrl:o,getWebcomBaseUrl:c,setDatastore:a,getDatastore:r,setRooms:i,getRooms:u,setReach:d,getReach:s,setWebrtc:l,getWebrtc:f,setSipPhoneNumbers:h,getSipPhoneNumbers:m}}},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var c=n(10),a=o(c),r=n(5),i=o(r),u=n(4),d=o(u),s="ONGOING",l="ACCEPTED",f="REJECTED",h="CANCELED",m="CONNECTED",v="OPEN",p=function(e,t){function n(){j=M.child("userList/"+C+"/connectedList/"+d["default"].appInstanceId),j.onDisconnect().remove(),j.child("status").set(m);try{!function(){var e=j.child("description");d["default"].appInstanceId&&e.child("appInstanceId").set(d["default"].appInstanceId);var t={},n=["appCodeName","appName","appVersion","buildID","cookieEnabled","language","onLine","oscpu","platform","product","productSub","securityPolicy","userAgent","vendor","vendorSub"];n.forEach(function(e){navigator[e]&&(t[e]=navigator[e])}),e.child("navigator").set(t)}()}catch(e){console.error("(ReachSDK::reach::init)failed to get information about device. error="+e)}M.child("userList/"+C+"/wasInsideReach").set(!0)}function o(e,t){console.log("(ReachSDK::reach::_isConnected)userId: "+e),M.child("userList/"+e+"/connectedList").once("value",function(e){t&&"function"==typeof t&&t(null!==e.val())})}function c(e,t){console.log("(ReachSDK::reach::_isRegistered)userId: "+e),M.child("userList/"+e+"/wasInsideReach").once("value",function(e){t&&"function"==typeof t&&t(null!==e.val())})}function r(e){j&&j.child("status").set(e)}function u(e){O&&(M.child("userList").off("child_added",O),O=null),e&&"function"==typeof e&&(O=function(t){console.log("(ReachSDK::reach::onUserAddedCb) "+t.name()+"="+(0,i["default"])(t.val()));var n={};n[t.name()]=t.val(),e(n)},M.child("userList").on("child_added",O))}function p(e){E&&(M.child("userList").off("child_changed",E),E=null),e&&"function"==typeof e&&(E=function(t){console.log("(ReachSDK::reach::onUserChangedCb) "+t.name()+"="+(0,i["default"])(t.val()));var n={};n[t.name()]=t.val(),e(n)},M.child("userList").on("child_changed",E))}function b(e){T&&(M.child("userList").off("child_removed",T),T=null),e&&"function"==typeof e&&(T=function(t){console.log("(ReachSDK::reach::onUserRemovedCb) "+t.name()+"="+(0,i["default"])(t.val()));var n={};n[t.name()]=t.val(),e(n)},M.child("userList").on("child_removed",T))}function S(e){L&&(M.child("invitationList/"+C).off("child_added",L),L=null),e&&"function"==typeof e&&(L=function(t){t.val().status===s&&!function(){console.log("(ReachSDK::reach::_setOnNewRoomInvitation)new Invite received,id) "+t.name()+",content="+(0,i["default"])(t.val()));var n=t.name();W||(W=[]),W[n]&&(W[n].timeout&&clearTimeout(W[n].timeout),delete W[n]),W[n]={};var o={};o[n]=t.val(),e(o);var c=M.child("invitationList/"+C+"/"+n);x&&(W[n].timeout=setTimeout(function(){x&&(console.log("(ReachSDK::reach::_setOnNewRoomInvitation)automatic reject of Invite received="+(0,i["default"])(t.val())),c.onDisconnect().cancel(),U?c.update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:f,status_info:U}):c.update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:f}))},x)),c.once("child_changed",function(e){e&&"status"===e.name()&&e.ref().parent().once("value",function(t){var n=void 0,o=void 0;if(t){n=e.ref().parent().name(),o=t.val();var c={};c[n]=o,W&&W[n]&&W[n].timeout&&clearTimeout(W[n].timeout),console.log("(ReachSDK::reach::_setOnNewRoomInvitation)Invite changed,id=) "+n+", new content="+(0,i["default"])(o)),c&&P&&P(c),delete W[n]}})})}()},M.child("invitationList/"+C).on("child_added",L))}function g(e){P&&(P=null),e&&"function"==typeof e&&(P=e)}function I(e,t){x&&(x=null),U&&(U=null),e&&e===parseInt(e,10)&&e>0&&(console.log("(ReachSDK::reach::_setNewRoomInvitationTimeout)timeout="+e),x=e),t&&(U=t)}function w(e,n,o){return console.log("(ReachSDK::reach::_isUserPresentInRoom)p_roomId="+e+" p_user="+n),e&&"string"==typeof e?n&&"string"==typeof n?o&&"function"==typeof o?void t.getRooms().child(e+"/participantList/"+n+"/wasInsideRoom").once("value",function(t){var c=null!==t.val();console.log("(ReachSDK::reach::_isUserPresentInRoom)p_roomId="+e+",p_user="+n+",result="+c),o(c,e,n)}):void console.error("(ReachSDK::reach::_isUserPresentInRoom)parameter p_cb is incorrect. if defined, expecting a function"):void console.error("(ReachSDK::reach::_isUserPresentInRoom)parameter p_user is incorrect. Expecting non empty string"):void console.error("(ReachSDK::reach::_isUserPresentInRoom)parameter p_roomid is incorrect. Expecting non empty string")}function _(e,t,n){return e&&"string"==typeof e?t&&!t instanceof Array?void console.error("(ReachSDK::reach::_cancelInvitation)parameter p_guestIds is incorrect. Expecting an Array"):(console.log(" (ReachSDK::reach::_cancelInvitation)p_roomId="+e+", p_guestIds="+(0,i["default"])(t)),void(V&&V[e]?t?t.forEach(function(t,o){t&&"string"==typeof t?V[e][t]?V[e][t].InviteDataref?(V[e][t].InviteDataref.onDisconnect().cancel(),V[e][t].InviteChangedCb&&"function"==typeof V[e][t].InviteChangedCb&&V[e][t].InviteDataref.off("child_changed",V[e][t].InviteChangedCb),V[e][t].InviteDataref.once("value",function(o){var c=void 0,a=void 0,r=void 0;o&&o.val()&&(c=o.val().status,r=o.val().room,a=o.ref().parent().name(),c&&c===s?(V[r][a].InviteDataref.update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:h}),V[r][a].statusChangedCb&&"function"==typeof V[r][a].statusChangedCb&&V[r][a].statusChangedCb(r,a,h),console.log("(ReachSDK::reach::_cancelInvitation)deleting Invite to room "+r+" for invitee "+a)):console.warn("(ReachSDK::reach::_cancelInvitation)cannot delete intivation to room "+r+" for guest "+a+" Invitation has been removed/rejected/accepted")),delete V[e][t],n&&"function"==typeof n&&n(t)})):(delete V[e][t],n&&"function"==typeof n&&n(t)):n&&"function"==typeof n&&n(t):console.error("(ReachSDK::reach::inviteToRoom)parameter p_guestIds["+o+"] is incorrect. Expecting non empty string")}):(0,a["default"])(V[e]).forEach(function(t){_(e,[t],n)}):console.warn("(ReachSDK::reach::_cancelInvitation) Invite to room "+e+" not found"))):void console.error("(ReachSDK::reach::_cancelInvitation)parameter p_roomid is incorrect. Expecting non empty string")}function R(e,n,o,c){if(!e||"string"!=typeof e)return void console.error("(ReachSDK::reach::inviteToRoom)parameter p_roomid is incorrect. Expecting non empty string");if(!o||"string"!=typeof o)return void console.error("(ReachSDK::reach::inviteToRoom)parameter p_topic is incorrect. Expecting non empty string");if(c&&"function"!=typeof c&&console.warn("(ReachSDK::reach::inviteToRoom)parameter p_statusChangedCb is incorrect. if defined, expecting a function"),!(n&&n instanceof Array))return void console.error("(ReachSDK::reach::inviteToRoom)parameter p_guestIds is incorrect. Expecting an Array");t.getRooms().child(e).child("commonDataList").update({status:v,owner:C});var a=function(e,n,o){e||t.getRooms().child(n+"/participantList/"+o).update({connected:!1,wasInsideRoom:!1})},r=function(t){if(console.log("(ReachSDK::reach::inviteToRoom::_InviteChangedCb)"),t&&"status"===t.name()){var n=t.ref().parent().parent().name();console.log("(ReachSDK::reach::inviteToRoom::_InviteChangedCb)cb_guestId2="+n),V&&V[e]&&V[e][n]&&V[e][n].InviteChangedCb&&V[e][n].InviteDataref.off("child_changed",V[e][n].InviteChangedCb),t.ref().parent().once("value",function(e){var t=void 0,n=void 0,o=void 0,c=void 0;e?(t=e.val().status,o=e.val().room,c=e.val().status_info,n=e.ref().parent().name(),console.log("(ReachSDK::reach::inviteToRoom::_InviteChangedCb)roomId="+o+" invitee="+n+" new invitation status="+t+" status info="+c),V&&V[o]&&V[o][n]&&V[o][n].InviteDataref?(V[o][n].InviteDataref.onDisconnect().cancel(),V[o][n].statusChangedCb&&"function"==typeof V[o][n].statusChangedCb?V[o][n].statusChangedCb(o,n,t,c):console.warn("(ReachSDK::reach::inviteToRoom::_InviteChangedCb)cannot retrieve mathing p_statusChangedCb"),delete V[o][n]):console.warn("(ReachSDK::reach::inviteToRoom::_InviteChangedCb)cannot retrieve mathing mOutgoingInvite")):console.warn("(ReachSDK::reach::inviteToRoom::_InviteChangedCb)cannot retrieve invitation")})}};n.forEach(function(t,n){if(t&&"string"==typeof t){if(console.log("(ReachSDK::reach::inviteToRoom)roomId="+e+" invitee="+t.toString()),V[e]&&V[e][t])return void _(e,[t],function(n){n&&n===t&&R(e,[n],o,c)});V[e]||(V[e]=[]),V[e][t]={},w(e,t,a),V[e][t].InviteDataref=M.child("invitationList").child(t).push({from:C,room:e,timestamp_creation:Webcom.ServerValue.TIMESTAMP,topic:o,status:s}),console.log("(ReachSDK::reach::inviteToRoom)InviteDataref="+V[e][t].InviteDataref.toString()),V[e][t].InviteChangedCb=r,V[e][t].InviteDataref.on("child_changed",V[e][t].InviteChangedCb),V[e][t].statusChangedCb=c,V[e][t].InviteDataref.onDisconnect().update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:h})}else console.error("(ReachSDK::reach::inviteToRoom)parameter p_guestIds["+n+"] is incorrect. Expecting non empty string")})}function D(e){var t=(0,a["default"])(e)[0];return t?e[t]?void M.child("invitationList/"+C+"/"+t).once("value",function(n){var o=void 0,c=void 0,a=void 0;n&&n.val()&&(a=n.name(),o=n.val().status,c=n.ref().parent().name(),o&&o===s?(console.log("(ReachSDK::reach::_acceptInvitation)inviteId="+t+",data="+(0,i["default"])(e[t])),M.child("invitationList/"+c+"/"+a).update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:l})):console.warn("(ReachSDK::reach::_acceptInvitation)inviteId="+a+",data="+(0,i["default"])(e[t])+", cannot be accepted. It has been removed or canceled"))}):void console.error("(ReachSDK::reach::_acceptInvitation)parameter p_invitation is incorrect. cannot get invitation data"):void console.error("(ReachSDK::reach::_acceptInvitation)parameter p_invitation is incorrect. cannot get invitation Id")}function y(e,t){var n=(0,a["default"])(e)[0];return n?e[n]?void M.child("invitationList/"+C+"/"+n).once("value",function(o){var c=void 0,a=void 0,r=void 0;o&&o.val()&&(r=o.name(),c=o.val().status,a=o.ref().parent().name(),c&&c===s?(console.log("(ReachSDK::reach::_rejectInvitation)inviteId="+n+",data="+(0,i["default"])(e[n])),t?M.child("invitationList/"+a+"/"+r).update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status_info:t,status:f}):M.child("invitationList/"+a+"/"+r).update({timestamp_end:Webcom.ServerValue.TIMESTAMP,status:f})):console.warn("(ReachSDK::reach::_rejectInvitation)inviteId="+r+",data="+(0,i["default"])(e[n])+", cannot be rejected. It has been removed or canceled"))}):void console.error("(ReachSDK::reach::_rejectInvitation)parameter p_invitation is incorrect. cannot get invitation data"):void console.error("(ReachSDK::reach::_rejectInvitation)parameter p_invitation is incorrect. cannot get invitation Id")}function k(e,n){e&&n&&"function"==typeof n&&!function(){var o=(0,a["default"])(e)[0];console.log("(ReachSDK::reach::_isRoomActive)inviteId="+o);var c=e[o].room;t.getRooms().child(c+"/commonDataList/status").once("value",function(e){var t=e&&e.val()&&e.val()===v;console.log("(ReachSDK::reach::_isRoomActive)inviteId="+o+" result="+t),n(t)})}()}function K(e,t){console.log("(ReachSDK::reach::_archiveInvitations)userId="+e),M.child("invitationList/"+C).once("value",function(n){n&&n.hasChildren()?!function(){var o=n.numChildren(),c=0;n.forEach(function(n){if(n&&n.val())if(console.log("(ReachSDK::reach::_archiveInvitations)userId="+e+" inviteId="+n.name()),n.val().status===f||n.val().status===h)M.child("invitationListHistory/"+e+"/"+n.name()).update(n.val()),n.ref().remove(),c++,c>=o&&t&&"function"==typeof t&&t();else{var a={};a[n.name()]=n.val(),k(a,function(a){if(a)c++,c>=o&&t&&"function"==typeof t&&t();else{if(n.val().status===s){var r=n.val();r.status=h,M.child("invitationListHistory/"+e+"/"+n.name()).set(r)}else M.child("invitationListHistory/"+e+"/"+n.name()).set(n.val());n.ref().remove(),c++,c>=o&&t&&"function"==typeof t&&t()}})}else t&&"function"==typeof t&&t()})}():t&&"function"==typeof t&&t()})}function A(){console.log("(ReachSDK::reach::_close)"),L&&(M.child("invitationList").child(C).off("child_added",L),L=null),O&&(M.child("userList").off("child_added",O),O=null),E&&(M.child("userList").off("child_changed",E),E=null),T&&(M.child("userList").off("child_removed",T),T=null),V&&(V.forEach(function(e){V[e].forEach(function(e){e.InviteDataref&&(e.InviteDataref.onDisconnect().cancel(),e.InviteDataref.update({status:h,timestamp_end:Webcom.ServerValue.TIMESTAMP}))})}),V=[]),x&&(x=null),U&&(U=null),j&&(j.remove(),j=null)}var C=e,M=t.getReach(),O=null,E=null,T=null,L=null,P=null,V=[],W=[],x=null,U=null,j=null;return n(),{getMe:function(){return C},isConnected:o,isRegistered:c,setConnectedStatus:r,setOnUserAdded:u,setOnUserChanged:p,setOnUserRemoved:b,inviteToRoom:R,cancelInvitation:_,setOnNewRoomInvitation:S,setOnRoomInvitationChanged:g,setNewRoomInvitationTimeout:I,archiveMyInvitations:function(e){return K(C,e)},acceptInvitation:D,rejectInvitation:y,on:function(e,t){switch(e){case"newRoomInvitation":S(t);break;case"roomInvitationChanged":g(t);break;case"userAdded":u(t);break;case"userChanged":p(t);break;case"userRemoved":b(t);break;default:return console.error("reach.set: no such event"),-1}},close:A}};t["default"]=p},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var c=n(10),a=o(c),r=n(5),i=o(r);t["default"]=function(e,t,n,o){function c(e){console.log("(ReachSDK::room["+L+"]::_addAvailableStream)data="+(0,i["default"])(e)),x.push(e)}function r(e){if(console.log("(ReachSDK::room["+L+"]::_removeAvailableStream)streamId="+e),x&&e)for(var t=x.length-1;t>=0;t--)x[t]&&(0,a["default"])(x[t])[0]&&(0,a["default"])(x[t])[0]===e&&delete x[t]}function u(){G||(G=function(e){var t={},n=e.name(),o=e.val();console.log("(ReachSDK::room["+L+"]::onPublishedStreamForAvailableStream)stream="+(0,i["default"])(o)),t[n]=o,t[n].roomId=L,c(t)},V.child("publishedMediaList").on("child_added",G)),J||(J=function(e){var t=e.name();console.log("(ReachSDK::room["+L+"]::onUnPublishedStreamForAvailableStream)stream="+t),r(t)},V.child("publishedMediaList").on("child_removed",J))}function s(){V.child("participantList/"+P).update({connected:!0,wasInsideRoom:!0}),V.child("participantList/"+P+"/connected").onDisconnect().set(!1),u()}function f(){return L}function v(){return P}function p(e){var t=V.child("participantList");B&&(t.off("child_added",B),B=null),H&&(t.off("child_changed",H),H=null),e&&"function"==typeof e?(B=function(t){var n=t.name();t.val()&&t.val().connected&&t.val().wasInsideRoom&&(console.log("(ReachSDK::room["+L+"]::_setOnParticipantJoin) user has joined: "+n),e(n))},t.on("child_added",B),H=function(t){var n=t.name();t.val()&&t.val().connected&&t.val().wasInsideRoom&&(console.log("(ReachSDK::room["+L+"]::_setOnParticipantJoin) user has joined: "+n),e(n))},t.on("child_changed",H)):console.error("(ReachSDK::room["+L+"]::_setOnParticipantJoin)parameter incorrect. Expected function")}function b(e){$&&(V.child("participantList").off("child_changed",$),$=null),e&&"function"==typeof e?($=function(t){var n=t.name();t.val()&&!t.val().connected&&t.val().wasInsideRoom&&(console.log("(ReachSDK::room["+L+"]::_setOnParticipantLeave) user has left: "+n),e(n))},V.child("participantList").on("child_changed",$)):console.error("(ReachSDK::room["+L+"]::_setOnParticipantLeave)parameter incorrect. Expected function")}function S(e){""!==e&&(console.log("(ReachSDK::room["+L+"]::sendInstantMessage)message="+e),V.child("instantMessageList").push({from:P,message:e,timestamp:Webcom.ServerValue.TIMESTAMP}))}function g(e){Y&&(V.child("instantMessageList").off("child_added",Y),Y=null),e&&"function"==typeof e?(Y=function(t){var n=t.val();console.log("(ReachSDK::room["+L+"]::_setOnInstantMessage)receive InstantMessage="+(0,i["default"])(n)),e(n)},V.child("instantMessageList").on("child_added",Y)):console.error("(ReachSDK::room["+L+"]::_setOnInstantMessage)parameter incorrect. Expected function")}function I(e,t,n,c){if(console.log("(ReachSDK::room["+L+"]::publishStream)roomId="+L+",streamId="+e+",me="+P+",actionType="+n),!e||"string"!=typeof e)return void console.error("(ReachSDK::reach::inviteToRoom)parameter streamId is incorrect. Expecting non empty string");var a=V.child("publishedMediaList").child(e),r=a.child("subscribersList"),u=function(){a.set({from:P,appInstanceId:h["default"].appInstanceId,actionType:n}),a.onDisconnect().remove();var c=function(c){var a=c.name(),r=c.val(),u=r.userId,d=r.peercoId,s=r.peercoRef,l=j[e]&&j[e].audio,f=j[e]&&j[e].video,h=e+"_pub";console.log("(ReachSDK::room["+L+"]::publishStream::addSubscribersListCb)subscriber "+u+" to stream "+e+" added "+(0,i["default"])(r)),W[h]||(W[h]=[]);var m=o.createWebrtc(t,a,function(){console.log("(ReachSDK::room["+L+"]::publishStream::addSubscribersListCb)subscriber "+u+" to stream "+e+" connection lost")},!0,n,d,s,l,f);W[h].push({stackId:m,subscriberId:u,isPublish:!0,peercoId:d,peercoRef:s,streamId:e})},u=function(t){var n=t.val().userId,c=W[e+"_pub"];if(n&&c){console.log("(ReachSDK::room["+L+"]::publishStream::removeSubscribersListCb)subscriber "+n+" to stream "+e+" removed");for(var a=c.length-1;a>=0;a--)c[a].subscriberId===n&&(o.closeWebrtc(c[a].stackId,!0),W[e+"_pub"].splice(a,1))}};U[e]={addSubscribersListCb:c,removeSubscribersListCb:u},r.on("child_added",c),r.on("child_removed",u)};n&&(n===d["default"].ACTION_TYPE_VIDEO?l["default"].connectLocalVideoStream(t,u,c):n===d["default"].ACTION_TYPE_AUDIO?l["default"].connectLocalAudioStream(t,u,c):n===d["default"].ACTION_TYPE_AUDIO_VIDEO&&l["default"].connectLocalAudioVideoStream(t,u,c))}function w(e){F&&(V.child("publishedMediaList").off("child_added",F),F=null),e&&"function"==typeof e?(F=function(t){var n={},o=t.name();n[o]=t.val(),n[o].roomId=L,e(n)},V.child("publishedMediaList").on("child_added",F)):console.error("(ReachSDK::room["+L+"]::_setOnPublishedStream)parameter incorrect. Expected function")}function _(e,t){console.log("(ReachSDK::room["+L+"]::unPublishStream)streamId "+e);var n=V.child("publishedMediaList/"+e),c=n.child("subscribersList"),a=e+"_pub";U[e]&&U[e].addSubscribersListCb&&c.off("child_added",U[e].addSubscribersListCb),U[e]&&U[e].removeSubscribersListCb&&c.off("child_removed",U[e].removeSubscribersListCb),delete U[e],delete j[e],n.onDisconnect().cancel(),n.remove(),W[a]&&W[a].length>0?!function(){for(var e=W[a].length,n=function(){e--,1>e&&(delete W[a],t&&"function"==typeof t&&t())},c=e-1;c>=0;c--)o.closeWebrtc(W[a][c].stackId,!0,n);l["default"].close()}():(delete W[a],t&&"function"==typeof t&&t())}function R(e){z&&(V.child("publishedMediaList").off("child_removed",z),z=null),e&&"function"==typeof e?(z=function(t){e(t.name())},V.child("publishedMediaList").on("child_removed",z)):console.error("(ReachSDK::room["+L+"]::_setOnUnPublishedStream)parameter incorrect. Expected function")}function D(e,t,c){var r=(0,a["default"])(e)[0],i=e[r].actionType;if(console.log("(ReachSDK::room["+L+"]::subscribeToStream)streamId "+r),U&&U[r])return i&&(i===d["default"].ACTION_TYPE_VIDEO?l["default"].connectLocalVideoStream(t,c):i===d["default"].ACTION_TYPE_AUDIO?l["default"].connectLocalAudioStream(t,c):i===d["default"].ACTION_TYPE_AUDIO_VIDEO&&l["default"].connectLocalAudioVideoStream(t,c)),r;var u=e[r].appInstanceId,s=V.child("publishedMediaList").child(r),f=s.child("subscribersList"),m=r+"_sub",v=void 0,p=void 0;W[m]?W[m]&&W[m][0]&&W[m][0].peercoId&&(v=W[m][0].peercoId):W[m]=[];var b=function(e,t){return Math.floor(Math.random()*(t-e+1))+e};v||(v=Math.floor(Date.now()).toString()+b(0,1e6)),p=n.getWebrtc().push().name(),f.child(h["default"].appInstanceId).set({ts:Webcom.ServerValue.TIMESTAMP,userId:P,peercoId:v,peercoRef:p});var S=j[r]&&j[r].audio,g=j[r]&&j[r].video,I=o.createWebrtc(t,u,function(){},!1,i,v,p,S,g,c);return N||(N=function(e){var t=e.val().from+"-stream",n=t+"_sub";if(console.log("(ReachSDK::room["+L+"]::remoteUnpublishedCb)streamId "+n),W[n]){for(var c=0;c<W[n].length;)o.closeWebrtc(W[n][c].stackId,!1),c++;delete W[n]}},V.child("publishedMediaList").on("child_removed",N)),W[m].push({stackId:I,isPublish:!1,peercoId:v,peercoRef:p,streamId:r}),r}function y(e){console.log("(ReachSDK::room["+L+"]::unSubscribeFromStream)streamId "+e);var t=V.child("publishedMediaList").child(e),n=t.child("subscribersList"),c=e+"_sub";
if(n.child(h["default"].appInstanceId).remove(),W[c]){for(var a=0;a<W[c].length;)W[c][a]&&o.closeWebrtc(W[c][a].stackId,!1),a++;delete W[c]}delete j[e]}function k(){return console.log("(ReachSDK::room["+L+"]::_getAvailableStreams)"),x}function K(e){if(console.log("(ReachSDK::room["+L+"]::_getAvailableStream)streamId="+e),x&&e)for(var t=x.length-1;t>=0;t--)if(x[t]&&(0,a["default"])(x[t])[0]&&(0,a["default"])(x[t])[0]===e)return x[t];return null}function A(){console.log("(ReachSDK::room["+L+"]::_removeAllAvailableStreams"),x=[]}function C(e){return e&&"string"==typeof e?(console.log("(ReachSDK::room["+L+"]::_muteAudioStream)streamId="+e),j[e]||(j[e]={}),j[e].audio=!0,void(W&&[W[e+"_pub"],W[e+"_sub"]].forEach(function(e){if(e&&e.length>0)for(var t=e.length-1;t>=0;t--)o.muteAudioWebrtcStack(e[t].stackId)}))):void console.error("(ReachSDK::room["+L+"]::_muteAudioStream)parameter streamId is incorrect. Expecting non empty string")}function M(e){return e&&"string"==typeof e?(j[e]&&j[e].audio&&(j[e].audio=!1),console.log("(ReachSDK::room["+L+"]::_unmuteAudioStream)streamId="+e),void(W&&[W[e+"_pub"],W[e+"_sub"]].forEach(function(e){if(e&&e.length>0)for(var t=e.length-1;t>=0;t--)o.unmuteAudioWebrtcStack(e[t].stackId)}))):void console.error("(ReachSDK::room["+L+"]::_unmuteAudioStream)parameter streamId is incorrect. Expecting non empty string")}function O(e){return e&&"string"==typeof e?(console.log("(ReachSDK::room["+L+"]::_muteVideoStream)streamId="+e),j[e]||(j[e]={}),j[e].video=!0,void(W&&[W[e+"_pub"],W[e+"_sub"]].forEach(function(e){if(e&&e.length>0)for(var t=e.length-1;t>=0;t--)o.muteVideoWebrtcStack(e[t].stackId)}))):void console.error("(ReachSDK::room["+L+"]::_muteVideoStream)parameter streamId is incorrect. Expecting non empty string")}function E(e){return e&&"string"==typeof e?(j[e]&&j[e].video&&(j[e].video=!1),console.log("(ReachSDK::room["+L+"]::_unmuteVideoStream)streamId="+e),void(W&&[W[e+"_pub"],W[e+"_sub"]].forEach(function(e){if(e&&e.length>0)for(var t=e.length-1;t>=0;t--)o.unmuteVideoWebrtcStack(e[t].stackId)}))):void console.error("(ReachSDK::room["+L+"]::_unmuteVideoStream)parameter streamId is incorrect. Expecting non empty string")}function T(e){console.log("(ReachSDK::room["+L+"]::_close)room "+L+", detroyRoom="+e);var t=V.child("participantList"),n=V.child("publishedMediaList");t.child(P+"/connected").set(!1),(0,a["default"])(U).forEach(_),U=[],Y&&(V.child("instantMessageList").off("child_added",Y),Y=null),F&&(n.off("child_added",F),F=null),G&&(n.off("child_added",G),G=null),z&&(n.off("child_removed",z),z=null),J&&(n.off("child_removed",J),J=null),B&&(t.off("child_added",B),B=null),H&&(t.off("child_changed",H),H=null),$&&(t.off("child_changed",$),$=null),N&&(n.off("child_removed",N),N=null),(0,a["default"])(W).forEach(function(e){W[e].forEach(function(t){e&&t&&!function(){var e=t.streamId,n=t.stackId,c=t.isPublish;c?_(e):y(e),setTimeout(function(){o.clearWebrtcStacks(n)},1e3)}()})}),setTimeout(function(){W={},j=[],A()},1100),e&&e===!0&&V.child("commonDataList/status").set(m),l["default"].close()}var L=t,P=e,V=n.getRooms().child(L),W={},x=[],U=[],j=[],N=null,Y=null,F=null,G=null,z=null,J=null,B=null,H=null,$=null;return s(),{getRoomId:f,getMe:v,setOnParticipantJoin:p,setOnParticipantLeave:b,sendInstantMessage:S,setOnInstantMessage:g,publishStream:I,setOnPublishedStream:w,unPublishStream:_,setOnUnPublishedStream:R,subscribeToStream:D,unSubscribeFromStream:y,getAvailableStreams:k,getAvailableStream:K,muteAudioStream:C,unmuteAudioStream:M,muteVideoStream:O,unmuteVideoStream:E,close:T,on:function(e,t){switch(e){case"instantMessage":g(t);break;case"publishedStream":w(t);break;case"unPublishedStream":R(t);break;case"participantJoin":p(t);break;case"participantLeave":b(t);break;default:console.err("(ReachSDK::room["+L+"]::on)unsupported "+e+" event")}}}};var u=n(3),d=o(u),s=n(9),l=o(s),f=n(4),h=o(f),m="CLOSE"},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var c=n(5),a=o(c),r=n(3),i=o(r),u=n(9),d=o(u),s="disconnected",l="connected",f="completed",h="checking",m="closed",v="failed",p="other",b={iceServers:[{url:"turns:turn1.webcom.orange.com:443",username:"admin",credential:"webcom1234"},{url:"turn:turn2.webcom.orange.com:443",username:"admin",credential:"webcom1234"},{url:"turns:turn3.webcom.orange.com:443",username:"admin",credential:"webcom1234"}]},S=function(e,t,n,o,c,r,u,S){function g(e){console.log("(ReachSDK::webrtc::)stackId="+U+"error="+e),console.dir(e)}function I(e,t){console.log("ReachSDK::webrtc::getIceServersConfigFromServer"),Y?Y.root().child("config").once("value",function(n){var o=n?n.val():null;o?"function"==typeof e&&e(o):"function"==typeof t&&t()},function(e){"function"==typeof t&&t(e)}):"function"==typeof t&&t()}function w(){F.child("iceCandidatesList").on("child_added",G)}function _(){F.child("iceCandidatesList").off("child_added",G)}function R(e,t){t&&t.forEach(function(t){t&&(t.enabled=e)})}function D(e){se=e;var t=j&&ae?ae:!j&&ce?ce:null;t&&R(!se,t.getAudioTracks())}function y(){console.log("(ReachSDK::webrtc::_muteAudio)stackId="+U),D(!0)}function k(){console.log("(ReachSDK::webrtc::_unmuteAudio)stackId="+U),D(!1)}function K(e){le=e;var t=j&&ae?ae:!j&&ce?ce:null;t&&R(!le,t.getVideoTracks())}function A(){console.log("(ReachSDK::webrtc::_muteVideo)stackId="+U),K(!0)}function C(){console.log("(ReachSDK::webrtc::_unmuteVideo)stackId="+U),K(!1)}function M(e){if(console.log("(ReachSDK::webrtc::_initlocalStream)stackId="+U+" get local video stream and renders to local video"),q){var t=void 0;q===i["default"].ACTION_TYPE_VIDEO?(t=function(){console.log("(ReachSDK::webrtc::_initlocalStream)initlocalStream_video"),ae=d["default"].getVideoStream()&&d["default"].getVideoStream().clone&&"function"==typeof d["default"].getVideoStream().clone?d["default"].getVideoStream().clone():d["default"].getVideoStream(),se&&y(),le&&A(),N.addStream(ae);for(var t=0;t<te.length;t++)console.log("(ReachSDK::webrtc::_initlocalStream)stackId="+U+" rendering local video to "+te[t].id),attachMediaStream(te[t],d["default"].getVideoStream());e&&"function"==typeof e&&e()},d["default"].getVideoStream()?t():(d["default"].addVideoListener(t),d["default"].initVideo())):q===i["default"].ACTION_TYPE_AUDIO?(t=function(){console.log("(ReachSDK::webrtc::_initlocalStream)initlocalStream_audio"),ae=d["default"].getAudioStream()&&d["default"].getAudioStream().clone&&"function"==typeof d["default"].getAudioStream().clone?d["default"].getAudioStream().clone():d["default"].getAudioStream(),se&&y(),le&&A(),N.addStream(ae);for(var t=0;t<te.length;t++)console.log("(ReachSDK::webrtc::_initlocalStream)stackId="+U+" rendering local Audio to "+te[t].id),attachMediaStream(te[t],d["default"].getAudioStream());e&&"function"==typeof e&&e()},d["default"].getAudioStream()?t():(d["default"].addAudioListener(t),d["default"].initAudio())):q===i["default"].ACTION_TYPE_AUDIO_VIDEO&&(t=function(){console.log("(ReachSDK::webrtc::_initlocalStream)initlocalStream_audio_video"),ae=d["default"].getAudioVideoStream()&&d["default"].getAudioVideoStream().clone&&"function"==typeof d["default"].getAudioVideoStream().clone?d["default"].getAudioVideoStream().clone():d["default"].getAudioVideoStream(),se&&y(),le&&A(),N.addStream(ae);for(var t=0;t<te.length;t++)console.log("(ReachSDK::webrtc::_initlocalStream)stackId="+U+" rendering local AudioVideo to "+te[t].id),attachMediaStream(te[t],d["default"].getAudioVideoStream());e&&"function"==typeof e&&e()},d["default"].getAudioVideoStream()?t():(d["default"].addAudioVideoListener(t),d["default"].initAudioVideo()))}else console.warn("(ReachSDK::webrtc::_initlocalStream)no actionType specified")}function O(){console.debug("(ReachSDK::webrtc::_initSdpCallbacks)stackId="+U),j?(z&&F.off("child_added",z),J=function(e){if(!re&&"sdpAnswer"===e.name()){var t=e.val();console.debug("(ReachSDK::webrtc::sdpAnswerCb)stackId="+U+"-received sdpAnswer: "+(0,a["default"])(t)),N.setRemoteDescription(new Z(t),function(){console.debug("(ReachSDK::webrtc::sdpAnswerCb)stackId="+U+"-remote description set"),w()},g),F.off("child_added",J)}},F.on("child_added",J)):(J&&F.off("child_added",J),z=function(e){if(!re&&"sdpOffer"===e.name()){var t=e.val();console.debug("(ReachSDK::webrtc::sdpOfferCb)stackId="+U+"-received sdpOffer: "+(0,a["default"])(t)),N.setRemoteDescription(new Z(t),function(){N.createAnswer(function(e){console.log("(ReachSDK::webrtc::sdpOfferCb)stackId="+U+"-sending answer"),N.setLocalDescription(e,function(){console.debug("(ReachSDK::webrtc::sdpOfferCb)stackId="+U+"-set sdpAnswer in base : "+(0,a["default"])(e)),Y.child("sdpAnswer").set(JSON.parse((0,a["default"])(e))),w()},g)},g,ve)},g),F.off("child_added",z)}},F.on("child_added",z))}function E(){J&&(F.off("child_added",J),J=null),z&&(F.off("child_added",z),z=null)}function T(){console.log("(webrtc::sendOffer)stackid="+U+"-creating sdpOffer"),N.createOffer(function(e){N.setLocalDescription(e,function(){console.debug("(ReachSDK::webrtc::createOffer)stackId="+U+"-set sdpOffer in base : "+(0,a["default"])(e)),Y.child("sdpOffer").set(JSON.parse((0,a["default"])(e)))},g)},g,me)}function L(e){if(ie||re)console.debug("(ReachSDK::webrtc::_close)stackId="+U+"-closing webrtc stack already in progress");else{ie=!0,de=e,console.debug("(ReachSDK::webrtc::_close)stackId="+U+"-closing webrtc stack"),N&&N.close(),B&&(F.off("child_added",B),B=null),G&&(_(),G=null),E();for(var t=0;t<te.length;t++)te[t]&&(detachMediaStream(te[t]),console.debug("(ReachSDK::webrtc::_close)stackId="+U+"-stopping local video to "+te[t].id));for(var n=0;n<ne.length;n++)ne[n]&&(detachMediaStream(ne[n]),console.debug("(ReachSDK::webrtc::_close)stackId="+U+"-stopping remote vid to "+ne[n].id));re=!0,console.debug("(ReachSDK::webrtc::_close)stackId="+U+"-closing webrtc stack -> waiting for ICE_CONNECTION_STATE_DISCONNECTED"),!re||ue!==s&&ue!==m&&ue!==v||(console.debug("(ReachSDK::webrtc::_close)stackId="+U+"-closed webrtc stack complete"),N=null,ie=!1,x.clearWebrtcStacks($),de&&"function"==typeof de&&de())}}function P(e,t){q&&(q===i["default"].ACTION_TYPE_VIDEO?d["default"].connectLocalVideoStream(e,t):q===i["default"].ACTION_TYPE_AUDIO?d["default"].connectLocalAudioStream(e,t):q===i["default"].ACTION_TYPE_AUDIO_VIDEO&&d["default"].connectLocalAudioVideoStream(e,t))}function V(e,t){e?ce?(attachMediaStream(e,ce),t&&"function"==typeof t&&t(ce)):(ne.push(e),t&&"function"==typeof t&&oe.push(t)):ce?t&&"function"==typeof t&&t(ce):t&&"function"==typeof t&&oe.push(t)}function W(){console.log("(ReachSDK::webrtc::init_pc)stackId="+U+"_config=",(0,a["default"])(Q)),N=new X(Q,he),N.onicecandidate=function(e){e.candidate&&(console.log("(ReachSDK::webrtc::pc.onicecandidate)stackId="+U+" send ice candidate="+(0,a["default"])(e.candidate)),Y.child("iceCandidatesList").push({label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}))},N.onaddstream=function(e){console.debug("(ReachSDK::webrtc::onaddstream)stackId="+U+"-stream:"+(0,a["default"])(e.stream)),e&&e.stream&&(ce=e.stream,se&&y(),le&&A())},N.oniceconnectionstatechange=function(){N&&N.iceConnectionState===h?(console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+U+"-checking"),ue=h):N&&N.iceConnectionState===l?(ue=l,console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+U+"-connected"),ce&&(ne.forEach(function(e){e&&(console.debug("(ReachSDK::webrtc::onaddstream)pc.onaddstream stackId="+U+"-rendering remote vid to "+e.id),attachMediaStream(e,ce))}),oe.forEach(function(e){e&&e(ce)}),oe=[]),_()):N&&N.iceConnectionState===f&&(ue=f,console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+U+"-"+f),_()),N&&N.iceConnectionState===s?(ue=s,console.log("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+U+"-remote disconnection, closing peer connection")):N&&N.iceConnectionState===m?(console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+U+"-closed"),ue=m,L()):N&&N.iceConnectionState===v?(console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+U+"-failed"),ue=v):(N?console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+U+"-"+N.iceConnectionState):console.debug("(ReachSDK::webrtc::oniceconnectionstatechange)stackId="+U+"-pc = null"),ue=p),!re||ue!==s&&ue!==m&&ue!==v||(console.debug("(ReachSDK::webrtc::_close)stackId="+U+"-closed webrtc stack complete"),N=null,ie=!1,x.clearWebrtcStacks($),H&&"function"==typeof H&&H(),de&&"function"==typeof de&&de())},G=function(e){var t=e.val(),n=new ee({sdpMLineIndex:t.label,candidate:t.candidate,sdpMid:t.id});console.log("(ReachSDK::webrtc::iceCandidatesListCb)stackId="+U+"received ice candidate="+(0,a["default"])(n)),N.addIceCandidate(n)},j?M(function(){O(),T()}):O()}var x=e,U=(new Date).getTime(),j=t,N=null,Y=n,F=o,G=null,z=null,J=null,B=null,H=null,$=c,q=r,Q=null,X=null,Z=null,ee=null,te=[],ne=[],oe=[],ce=null,ae=null,re=!1,ie=!1,ue=null,de=null,se=!1,le=!1;console.log("(ReachSDK::webrtc::)stackId=${stackId} isPublish=${isPublish},localDataRef=${localDataRef},remoteDataRef=${remoteDataRef})");var fe={DtlsSrtpKeyAgreement:!0},he={optional:[fe]},me={mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}},ve={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};return function(){if(console.log("(ReachSDK::webrtc::init)stackId="+U),"function"!=typeof RTCPeerConnection)throw console.error("(ReachSDK::webrtc::init)stackId="+U+" error=Webrtc is not supported on this browser !"),new Error("Webrtc is not supported on this browser !");if(X=RTCPeerConnection,"function"!=typeof RTCSessionDescription)throw console.error("(ReachSDK::webrtc::init)stackId="+U+" error2=Webrtc is not supported on this browser !"),new Error("Webrtc is not supported on this browser !");if(Z=RTCSessionDescription,"function"!=typeof RTCIceCandidate)throw console.error("(ReachSDK::webrtc::init)stackId="+U+" error3=Webrtc is not supported on this browser !"),new Error("Webrtc is not supported on this browser !");ee=RTCIceCandidate,u&&(se=!0),S&&(le=!0),I(function(e){Q=e,console.log("(ReachSDK::webrtc::) use server config=",(0,a["default"])(Q)),W()},function(){"undefined"!=typeof b?(Q=b,console.log("(ReachSDK::webrtc::) use DEFAULT_ICE_CONFIG config=",(0,a["default"])(Q))):console.log("(ReachSDK::webrtc::) no ice  config"),W()})}(),{setOnClose:function(e){H=e},close:function(e){console.debug("(ReachSDK::webrtc::_close)stackId="+U+"-close requested"),L(e)},connectLocalStream:P,connectRemoteStream:V,muteAudio:y,unmuteAudio:k,muteVideo:A,unmuteVideo:C}};t["default"]=S},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0});var c=n(4),a=o(c),r=n(20),i=o(r),u=function(e){function t(t,n,o,c,r,u,d,s,l,v){var p=u,b=e.getWebrtc().child(d+"/"+a["default"].appInstanceId),S=e.getWebrtc().child(d+"/"+n),g=void 0;g=c?{webRtcStackId:p,localVid:t}:{webRtcStackId:p,remoteVid:t};var I=h.push(g)-1;if(f[p])console.debug("ReachSDK::webrtcmngr::createWebrtc->use existing real webrtcStack"),c?(f[p].isPublished++,f[p].stack.connectLocalStream(t,v)):(f[p].isSubscribed++,f[p].stack.connectRemoteStream(t,v));else{console.debug("ReachSDK::webrtcmngr::createWebrtc->create a new real webrtcStack");var w=(0,i["default"])(m,c,b,S,p,r,s,l);w.setOnClose(o),c?(f[p]={stack:w,isPublished:1,isSubscribed:0},w.connectLocalStream(t,v)):(f[p]={stack:w,isPublished:0,isSubscribed:1},w.connectRemoteStream(t,v))}return console.debug("ReachSDK::webrtcmngr::createWebrtc->webrtcStack:"+p+" new isPublished count ="+f[p].isPublished+" new isSubscribed count ="+f[p].isSubscribed),I}function n(e,t,n){if(console.debug("ReachSDK::webrtcmngr::closeWebrtc->id="+e),!h[e])return console.warn("ReachSDK::webrtcmngr::closeWebrtc: virtualstack "+e+" not found"),n&&"function"==typeof n&&n(),!1;var o=h[e].webRtcStackId;return o&&f[o]?(t&&f[o].isPublished>0?f[o].isPublished--:!t&&f[o].isSubscribed>0&&f[o].isSubscribed--,f[o].isPublished<1&&f[o].isSubscribed<1?(console.debug("ReachSDK::webrtcmngr::closeWebrtc->destroy  real webrtcStack:"+o),f[o].stack.close(n),f[o]=null):(console.debug("ReachSDK::webrtcmngr::closeWebrtc->decrement  real webrtcStack:"+o+" new isPublished count ="+f[o].isPublished+" new isSubscribed count ="+f[o].isSubscribed),n&&"function"==typeof n&&n())):(n&&"function"==typeof n&&n(),console.warn("ReachSDK::webrtcmngr::closeWebrtc cannot found real stack")),h[e].remoteVid&&detachMediaStream(h[e].remoteVid),h.splice(e,1),!0}function o(e){return console.debug("ReachSDK::webrtcmngr::clearWebrtcStacks id="+e),e&&f&&f[e]&&(f[e]=null),!0}function c(e){if(console.log("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e),h&&h[e]&&h[e].webRtcStackId){var t=h[e].webRtcStackId;console.log("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e+" webRtcStackId="+t),f&&f[t]&&f[t].stack?f[t].stack.muteAudio():console.warn("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) webrtcStack="+t+" not found")}else console.warn("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e+" not found")}function r(e){if(console.log("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e),h&&h[e]&&h[e].webRtcStackId){var t=h[e].webRtcStackId;console.log("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e+",webRtcStackId="+t),f&&f[t]&&f[t].stack?f[t].stack.unmuteAudio():console.warn("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) webrtcStack="+t+" not found")}else console.warn("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e+" not found")}function u(e){if(console.log("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e),h&&h[e]&&h[e].webRtcStackId){var t=h[e].webRtcStackId;console.log("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e+" webRtcStackId="+t),f&&f[t]&&f[t].stack?f[t].stack.muteVideo():console.warn("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) webrtcStack="+t+" not found")}else console.warn("(ReachSDK::webrtcmngr::muteAudioWebrtcStack) virtualWebrtcStackId="+e+" not found")}function d(e){if(console.log("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e),h&&h[e]&&h[e].webRtcStackId){var t=h[e].webRtcStackId;console.log("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e+", webRtcStackId="+t),f&&f[t]&&f[t].stack?f[t].stack.unmuteVideo():console.warn("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) webrtcStack="+t+" not found")}else console.warn("(ReachSDK::webrtcmngr::_unmuteAudioWebrtcStack) virtualWebrtcStackId="+e+" not found")}function s(e){m=e}var l=this,f=[],h=[],m=void 0;return{createWebrtc:function(e,n,o,c,a,r,i,u,d,s){return t.bind(l)(e,n,o,c,a,r,i,u,d,s)},closeWebrtc:n,clearWebrtcStacks:o,muteAudioWebrtcStack:c,unmuteAudioWebrtcStack:r,muteVideoWebrtcStack:u,unmuteVideoWebrtcStack:d,setWebrtcManger:s}};t["default"]=u},function(e,t,n){e.exports={"default":n(26),__esModule:!0}},function(e,t){"use strict";t.__esModule=!0,t["default"]=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}t.__esModule=!0;var c=n(22),a=o(c);t["default"]=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),(0,a["default"])(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}()},function(e,t,n){var o=n(1),c=o.JSON||(o.JSON={stringify:JSON.stringify});e.exports=function(e){return c.stringify.apply(c,arguments)}},function(e,t,n){n(50);var o=n(1).Object;e.exports=function(e,t,n){return o.defineProperty(e,t,n)}},function(e,t,n){n(51),e.exports=n(1).Object.keys},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,n){var o=n(8);e.exports=function(e){if(!o(e))throw TypeError(e+" is not an object!");return e}},function(e,t,n){var o=n(15),c=n(46),a=n(45);e.exports=function(e){return function(t,n,r){var i,u=o(t),d=c(u.length),s=a(r,d);if(e&&n!=n){for(;d>s;)if(i=u[s++],i!=i)return!0}else for(;d>s;s++)if((e||s in u)&&u[s]===n)return e||s||0;return!e&&-1}}},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t,n){var o=n(28);e.exports=function(e,t,n){if(o(e),void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,o){return e.call(t,n,o)};case 3:return function(n,o,c){return e.call(t,n,o,c)}}return function(){return e.apply(t,arguments)}}},function(e,t,n){var o=n(8),c=n(7).document,a=o(c)&&o(c.createElement);e.exports=function(e){return a?c.createElement(e):{}}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t,n){var o=n(13),c=n(42);e.exports=n(2)?function(e,t,n){return o.f(e,t,c(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t,n){e.exports=!n(2)&&!n(6)(function(){return 7!=Object.defineProperty(n(33)("div"),"a",{get:function(){return 7}}).a})},function(e,t,n){var o=n(31);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==o(e)?e.split(""):Object(e)}},function(e,t,n){var o=n(35),c=n(15),a=n(30)(!1),r=n(43)("IE_PROTO");e.exports=function(e,t){var n,i=c(e),u=0,d=[];for(n in i)n!=r&&o(i,n)&&d.push(n);for(;t.length>u;)o(i,n=t[u++])&&(~a(d,n)||d.push(n));return d}},function(e,t,n){var o=n(39),c=n(34);e.exports=Object.keys||function(e){return o(e,c)}},function(e,t,n){var o=n(12),c=n(1),a=n(6);e.exports=function(e,t){var n=(c.Object||{})[e]||Object[e],r={};r[e]=t(n),o(o.S+o.F*a(function(){n(1)}),"Object",r)}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,n){var o=n(44)("keys"),c=n(49);e.exports=function(e){return o[e]||(o[e]=c(e))}},function(e,t,n){var o=n(7),c="__core-js_shared__",a=o[c]||(o[c]={});e.exports=function(e){return a[e]||(a[e]={})}},function(e,t,n){var o=n(14),c=Math.max,a=Math.min;e.exports=function(e,t){return e=o(e),0>e?c(e+t,0):a(e,t)}},function(e,t,n){var o=n(14),c=Math.min;e.exports=function(e){return e>0?c(o(e),9007199254740991):0}},function(e,t,n){var o=n(11);e.exports=function(e){return Object(o(e))}},function(e,t,n){var o=n(8);e.exports=function(e,t){if(!o(e))return e;var n,c;if(t&&"function"==typeof(n=e.toString)&&!o(c=n.call(e)))return c;if("function"==typeof(n=e.valueOf)&&!o(c=n.call(e)))return c;if(!t&&"function"==typeof(n=e.toString)&&!o(c=n.call(e)))return c;throw TypeError("Can't convert object to primitive value")}},function(e,t){var n=0,o=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+o).toString(36))}},function(e,t,n){var o=n(12);o(o.S+o.F*!n(2),"Object",{defineProperty:n(13).f})},function(e,t,n){var o=n(47),c=n(40);n(41)("keys",function(){return function(e){return c(o(e))}})}])});